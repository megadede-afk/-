<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>無限じゃんけん</title>
  <style>
    body { font-family: system-ui, sans-serif; background: #0f172a; color: #e2e8f0; display: flex; justify-content: center; padding: 20px; }
    .container { max-width: 720px; width: 100%; }
    h1 { text-align: center; margin-bottom: 8px; }

    .stat { font-size: 18px; margin: 4px 0; text-align: center; }
    .result-win { color: #ef4444; font-weight: bold; }
    .result-lose { color: #3b82f6; font-weight: bold; }

    .card { background: #111827; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.4); }

    .row { display: flex; gap: 16px; justify-content: center; }
    .column { display: flex; flex-direction: column; align-items: center; gap: 6px; }

    button { border: none; border-radius: 12px; padding: 14px 20px; font-size: 22px; cursor: pointer; background: #1f2937; color: #e5e7eb; }
    button:disabled { opacity: 0.4; cursor: not-allowed; }

    svg { width: 70px; height: 70px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>無限じゃんけん</h1>

    <div class="card">
      <div class="stat">現在ポイント: <span id="points">0</span></div>
      <div class="stat">総獲得ポイント: <span id="totalPoints">0</span></div>
      <div class="stat">状態: <span id="status">待機中</span></div>
      <div class="stat">相手確率: <span id="enemyProb">-</span></div>
    </div>

    <div class="card">
      <div class="row">

        <div class="column">
          <svg viewBox="0 0 36 36">
            <circle cx="18" cy="18" r="16" stroke="#374151" stroke-width="3" fill="none"/>
            <circle id="progRock" cx="18" cy="18" r="16" stroke="#22c55e" stroke-width="3" fill="none" stroke-dasharray="100" stroke-dashoffset="100" transform="rotate(-90 18 18)"/>
          </svg>
          <button id="btnRock" onclick="play('rock')">✊</button>
          <button id="upgradeRock"></button>
        </div>

        <div class="column">
          <svg viewBox="0 0 36 36">
            <circle cx="18" cy="18" r="16" stroke="#374151" stroke-width="3" fill="none"/>
            <circle id="progScissors" cx="18" cy="18" r="16" stroke="#22c55e" stroke-width="3" fill="none" stroke-dasharray="100" stroke-dashoffset="100" transform="rotate(-90 18 18)"/>
          </svg>
          <button id="btnScissors" onclick="play('scissors')">✌️</button>
          <button id="upgradeScissors"></button>
        </div>

        <div class="column">
          <svg viewBox="0 0 36 36">
            <circle cx="18" cy="18" r="16" stroke="#374151" stroke-width="3" fill="none"/>
            <circle id="progPaper" cx="18" cy="18" r="16" stroke="#22c55e" stroke-width="3" fill="none" stroke-dasharray="100" stroke-dashoffset="100" transform="rotate(-90 18 18)"/>
          </svg>
          <button id="btnPaper" onclick="play('paper')">✋</button>
          <button id="upgradePaper"></button>
        </div>

      </div>
    </div>

    <div class="card">
      <div class="row">
        <button onclick="toggleAuto()" id="autoBtn">自動OFF</button>
        <button onclick="toggleSound()" id="soundBtn">音ON</button>
      </div>
    </div>
  </div>

  <script>
    let points = 0;
    let totalPoints = 0;
    let cooldown = false;
    let auto = false;
    let soundOn = true;

    const multiplier = { rock:1, scissors:1, paper:1 };

    let lastPlayTime = 0;

    let enemyProb = { rock: 33.3, scissors: 33.3, paper: 33.3 };

    function saveGame(){
      const data = { points, totalPoints, multiplier, auto, soundOn, enemyProb };
      localStorage.setItem("infiniteJankenSave", JSON.stringify(data));
    }

    function loadGame(){
      const raw = localStorage.getItem("infiniteJankenSave");
      if(!raw) return;

      try{
        const data = JSON.parse(raw);
        points = data.points ?? 0;
        totalPoints = data.totalPoints ?? 0;
        Object.assign(multiplier, data.multiplier ?? {});
        auto = data.auto ?? false;
        soundOn = data.soundOn ?? true;
        enemyProb = data.enemyProb ?? enemyProb;
      }catch{}
    }

    function randomizeEnemyProb(){
      const r1 = Math.random()*100;
      const r2 = Math.random()*(100 - r1);
      const r3 = 100 - r1 - r2;

      enemyProb.rock = r1;
      enemyProb.scissors = r2;
      enemyProb.paper = r3;

      updateEnemyProbUI();
      saveGame();
    }

    function updateEnemyProbUI(){
      document.getElementById('enemyProb').textContent =
        `✊${enemyProb.rock.toFixed(1)}% / ✌️${enemyProb.scissors.toFixed(1)}% / ✋${enemyProb.paper.toFixed(1)}%`;
    }

    function formatJP(num){
      if(num < 10000) return Math.floor(num);
      const units = ["", "万", "億", "兆", "京"];
      let i = 0;
      while(num >= 10000 && i < units.length-1){ num /= 10000; i++; }
      return num.toFixed(2) + units[i];
    }

    function playSound(){
      if(!soundOn) return;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.frequency.value = 800;
      gain.gain.value = 0.2;
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.1);
    }

    function randomEnemy(){
      const r = Math.random()*100;
      if(r < enemyProb.rock) return 'rock';
      if(r < enemyProb.rock + enemyProb.scissors) return 'scissors';
      return 'paper';
    }

    function judge(p,e){
      if(p===e) return 0;
      if((p==='rock'&&e==='scissors')||(p==='scissors'&&e==='paper')||(p==='paper'&&e==='rock')) return 1;
      return -1;
    }

    function play(hand){
      if(cooldown) return;
      cooldown = true;
      lastPlayTime = Date.now();
      playSound();

      const enemy = randomEnemy();
      const result = judge(hand,enemy);

      if(result===1){
        let gain = multiplier[hand];
        points += gain;
        totalPoints += gain;
        setStatus('WIN','win');
      } else if(result===0){ setStatus('DRAW'); }
      else { setStatus('LOSE','lose'); }

      updateUI();
      saveGame();
      setTimeout(()=> cooldown=false, 1000);
    }

    function setStatus(text,type){
      const el = document.getElementById('status');
      el.textContent = text;
      el.className = type==='win' ? 'result-win' : type==='lose' ? 'result-lose' : '';
    }

    function toggleAuto(){
      auto=!auto;
      document.getElementById('autoBtn').textContent = auto?'自動ON':'自動OFF';
      saveGame();
    }

    function toggleSound(){
      soundOn=!soundOn;
      document.getElementById('soundBtn').textContent = soundOn?'音ON':'音OFF';
      saveGame();
    }

    function renderUpgrades(){
      const map={ rock:'upgradeRock', scissors:'upgradeScissors', paper:'upgradePaper' };
      Object.keys(multiplier).forEach(hand=>{
        const btn=document.getElementById(map[hand]);
        const cost=multiplier[hand]*5;
        btn.textContent=`${cost}P → x${multiplier[hand]*2}`;
        btn.disabled = points < cost;
        btn.onclick=()=>{
          if(points>=cost){
            points-=cost;
            multiplier[hand]*=2;
            updateUI();
            saveGame();
          }
        };
      });
    }

    function updateUI(){
      document.getElementById('points').textContent = formatJP(points);
      document.getElementById('totalPoints').textContent = formatJP(totalPoints);
      document.getElementById('autoBtn').textContent = auto?'自動ON':'自動OFF';
      document.getElementById('soundBtn').textContent = soundOn?'音ON':'音OFF';
      updateEnemyProbUI();
      renderUpgrades();
    }

    function updateVisuals(){
      const prog = Math.min(1, (Date.now()-lastPlayTime)/1000);
      const offset = 100 - prog*100;
      ['Rock','Scissors','Paper'].forEach(name=>{
        document.getElementById('prog'+name).style.strokeDashoffset = cooldown ? offset : 0;
      });

      requestAnimationFrame(updateVisuals);
    }

    loadGame();

    setInterval(randomizeEnemyProb, 60000);

    setInterval(()=>{
      if(auto && !cooldown){
        const hands=['rock','scissors','paper'];
        play(hands[Math.floor(Math.random()*3)]);
      }
    },100);

    updateUI();
    updateVisuals();
  </script>
</body>
</html>
